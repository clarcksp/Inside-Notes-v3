FROM node:20-alpine AS frontend-builder

WORKDIR /app

# Copia os arquivos de configura√ß√£o do Frontend
COPY package.json package-lock.json vite.config.ts ./

# Instala depend√™ncias
RUN npm install

# Copia todo o c√≥digo fonte
COPY . .

# Debug: Lista arquivos antes do build
RUN echo "üìÅ [DEBUG] Arquivos no diret√≥rio antes do build:" && ls -la

# Constr√≥i o projeto
RUN npm run build

# Debug: Verifica se a pasta dist foi criada e lista conte√∫do
RUN echo "üìÅ [DEBUG] Verificando pasta dist ap√≥s build:" && \
    if [ -d "dist" ]; then \
        echo "‚úÖ Pasta dist encontrada!" && ls -la dist/; \
    else \
        echo "‚ùå Pasta dist N√ÉO encontrada!" && ls -la; \
        exit 1; \
    fi

# Est√°gio Nginx
FROM nginx:1.25-alpine

# Remove configura√ß√£o padr√£o
RUN rm /etc/nginx/conf.d/default.conf

# Copia configura√ß√£o Nginx
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copia arquivos est√°ticos do build
COPY --from=frontend-builder /app/dist /usr/share/nginx/html

# Debug: Verifica se os arquivos foram copiados corretamente
RUN echo "üìÅ [DEBUG] Arquivos copiados para Nginx:" && ls -la /usr/share/nginx/html/

# Verifica se o index.html existe
RUN if [ -f "/usr/share/nginx/html/index.html" ]; then \
        echo "‚úÖ index.html encontrado!"; \
        echo "üìÑ [DEBUG] Conte√∫do do index.html:"; \
        head -20 /usr/share/nginx/html/index.html; \
    else \
        echo "‚ùå index.html N√ÉO encontrado!"; \
        exit 1; \
    fi

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
